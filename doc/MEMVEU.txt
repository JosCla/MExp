.MExp Move Entity with Undo

Lbl MVEU {
    .Move entity while logging undo stuff
    .r1: Entity pointer
    .r2: DispX
    .r3: DispY
    .r4: Layers of indirection from player push

    .Setting undo pointer from current undo block header
    {UN}^r+UN->UP
    INUP()

    .Num units to undo = 0
    0->NU

    .Start recording undos
    1->RU

    .Doing movement
    MVEF()

    .Logging an undo header
    UP-UN->{UN}^r
    0->{S-6}
    1->{S-5}
    NU->{S-4}
    LGUN()

    .Stop recording undos
    0->RU

    Return
}
